<!doctype html>
<html>
<head>
    <title>Example of the Authorization Code flow with Spotify</title>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <style type="text/css">
        #login, #loggedin {
            display: none;
        }

        .text-overflow {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 500px;
        }
    </style>
<body>
<div class="container">
    <div id="login">
        <h1>This is an example of the Authorization Code flow</h1>
        <a href="/login" class="btn btn-primary">Log in with Spotify</a>
    </div>
    <div id="loggedin">
        <div id="user-profile">
        </div>
        <div id="oauth">
        </div>
    </div>
</div>

<script id="user-profile-template" type="text/x-handlebars-template">
    <h1>Logged in as {{display_name}}</h1>
    <div class="media">
        <div class="pull-left">
            <img class="media-object" width="150" src="{{images.0.url}}"/>
        </div>
        <div class="media-body">
            <dl class="dl-horizontal">
                <dt>Display name</dt>
                <dd class="clearfix">{{display_name}}</dd>
                <dt>Id</dt>
                <dd>{{id}}</dd>
                <dt>Email</dt>
                <dd>{{email}}</dd>
                <dt>Spotify URI</dt>
                <dd><a href="{{external_urls.spotify}}">{{external_urls.spotify}}</a></dd>
                <dt>Link</dt>
                <dd><a href="{{href}}">{{href}}</a></dd>
                <dt>Profile Image</dt>
                <dd class="clearfix"><a href="{{images.0.url}}">{{images.0.url}}</a></dd>
                <dt>Country</dt>
                <dd>{{country}}</dd>
            </dl>
        </div>
    </div>
</script>

<script id="oauth-template" type="text/x-handlebars-template">
    <h2>oAuth info</h2>
    <dl class="dl-horizontal">
        <dt>Access token</dt>
        <dd class="text-overflow">{{access_token}}</dd>
        <dt>Refresh token</dt>
        <dd class="text-overflow">{{refresh_token}}</dd>
    </dl>
</script>
<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/mustache.js/3.0.1/mustache.min.js"></script>
<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
<!--chart js-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js"
        type="text/javascript"></script>
<script>
    (function () {
        let tracks = []
        let spotify_api = 'https://api.spotify.com/v1'

        function showNotification(type, message, timer = 2000) {
            $.notify({
                message: message
            }, {
                type: type,
                timer: timer,
                placement: {
                    from: 'top',
                    align: 'right'
                }
            })
        }

        function getHashParams() {
            let hashParams = {}
            let e, r = /([^&=]+)=?([^&]*)/g,
                q = window.location.hash.substring(1)
            while (e = r.exec(q)) {
                hashParams[e[1]] = decodeURIComponent(e[2])
            }
            return hashParams
        }

        function processLogin(isSuccess) {
            if (isSuccess) {
                $('#login').hide()
                $('#loggedin').show()
            } else {
                $('#login').show()
                $('#loggedin').hide()
            }
        }

        function getTracks(data) {
            data.items.forEach(function (item) {
                let temp = {
                    "id": item.track.id,
                    "played_at": item.played_at
                }
                tracks.push(temp)
            })
            getTracksFeatures()
            return tracks
        }

        function getTracksFeatures() {
            let ids = ""
            for (let i = 0; i < tracks.length; i++) {
                ids = ids.concat(tracks[i].id + ",")
            }
            renderData(null, "/audio-features/?ids=" + ids, null, false, getValence)
        }

        function getValence(data) {
            console.log(data)
        }

        function renderDataWithObject(template, target, object, isToAppend = false, successCallback = null) {
            let templateStructure = $(template).html()
            let output = Mustache.render(templateStructure, object)
            if (isToAppend) {
                $(target).append(output)
            } else {
                $(target).hide().html(output).fadeIn('slow')
            }
            if (successCallback != null) {
                successCallback(object)
            }
        }

        function renderData(template, url, target, isToAppend, successPreCall = null, successCallback = null, webChangeCall = null, errorCallback = null) {
            $.ajax({
                type: "get",
                url: spotify_api + url,
                dataType: "json",
                headers: {
                    "Authorization": "Bearer " + access_token
                },
                success: function (data, textStatus, jqXHR) {
                    if (successPreCall) {
                        data = successPreCall(data)
                    }
                    if (template) {
                        let status = jqXHR.status
                        let templateStructure = $(template).html()
                        let output = Mustache.render(templateStructure, data)
                        if (isToAppend) {
                            $(target).append(output)
                        } else {
                            $(target).hide().html(output).fadeIn('slow')
                        }
                    }
                    if (successCallback) {
                        successCallback(data, textStatus, jqXHR)
                    }
                    if (webChangeCall) {
                        webChangeCall(true)
                    }
                },
                error: function (jqXHR) {
                    let status = jqXHR.status
                    console.log(jqXHR)
                    showNotification('danger', 'Something went wrong')
                    if (errorCallback != null) {
                        errorCallback()
                    }
                }
            })
        }

        let params = getHashParams()

        let access_token = params.access_token,
            refresh_token = params.refresh_token,
            error = params.error

        if (error) {
            alert('There was an error during the authentication')
        } else {
            if (access_token) {
                // render oauth info
                let oauthSource = document.getElementById('oauth-template').innerHTML,
                    oauthTemplate = Handlebars.compile(oauthSource),
                    oauthPlaceholder = document.getElementById('oauth')

                oauthPlaceholder.innerHTML = oauthTemplate({
                    access_token: access_token,
                    refresh_token: refresh_token
                })
                renderData("#user-profile-template", "/me", "#user-profile", false, null, null, processLogin)
                renderData(null, "/me/player/recently-played", null, false, getTracks)
            } else {
                // render initial screen
                processLogin(false)
            }
        }
    })()
</script>
</body>
</html>

