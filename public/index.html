<!doctype html>
<html>
<head>
    <title>Example of the Authorization Code flow with Spotify</title>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <style type="text/css">
        #login, #loggedin {
            display: none;
        }

        .text-overflow {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 500px;
        }
    </style>
<body>
<div class="container">
    <div id="login">
        <h1>This is an example of the Authorization Code flow</h1>
        <a href="/login" class="btn btn-primary">Log in with Spotify</a>
    </div>
    <div id="loggedin" class="chart-container">
        <canvas id="valency-chart" width="400" height="600"></canvas>
    </div>
</div>

<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/mustache.js/3.0.1/mustache.min.js"></script>
<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
<!--chart js-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js"
        type="text/javascript"></script>
<script>
    (function () {
        let tracks = []
        let spotify_api = 'https://api.spotify.com/v1'

        function getHashParams() {
            let hashParams = {}
            let e, r = /([^&=]+)=?([^&]*)/g,
                q = window.location.hash.substring(1)
            while (e = r.exec(q)) {
                hashParams[e[1]] = decodeURIComponent(e[2])
            }
            return hashParams
        }

        function processLogin(isSuccess) {
            if (isSuccess) {
                $('#login').hide()
                $('#loggedin').show()
            } else {
                $('#login').show()
                $('#loggedin').hide()
            }
        }

        function getTracks(data) {
            data.items.forEach(function (item) {
                let temp = {
                    "id": item.track.id,
                    "played_at": item.played_at
                }
                tracks.push(temp)
            })
            getTracksFeatures()
            return tracks
        }

        function getTracksFeatures() {
            let ids = ""
            for (let i = 0; i < tracks.length; i++) {
                ids = ids.concat(tracks[i].id + ",")
            }
            renderData(null, "/audio-features/?ids=" + ids, null, false, getValence)
        }

        function getValence(data) {
            let temp = tracks
            tracks = []
            let features = data.audio_features
            for (let i = 0; i < features.length; i++) {
                let valence = features[i].valence
                let {id, played_at} = temp[i]
                tracks.push({
                    "id": id,
                    "played_at": played_at,
                    "valence": String(valence)
                })
            }
            drawValenceChart()
            return tracks
        }

        function drawValenceChart(isSuccess) {
            let labels = []
            let data = []
            for (let i = 0; i < tracks.length; i++) {
                let {played_at, valence} = tracks[i]
                labels.push(played_at)
                data.push(valence)
            }
            renderChart("valency-chart", "horizontalBar", labels, data)
        }

        function renderData(template, url, target, isToAppend, successPreCall = null, successCallback = null, webChangeCall = null, errorCallback = null) {
            $.ajax({
                type: "get",
                url: spotify_api + url,
                dataType: "json",
                headers: {
                    "Authorization": "Bearer " + access_token
                },
                success: function (data, textStatus, jqXHR) {
                    if (successPreCall) {
                        data = successPreCall(data)
                    }
                    if (template) {
                        let status = jqXHR.status
                        let templateStructure = $(template).html()
                        let output = Mustache.render(templateStructure, data)
                        if (isToAppend) {
                            $(target).append(output)
                        } else {
                            $(target).hide().html(output).fadeIn('slow')
                        }
                    }
                    if (successCallback) {
                        successCallback(data, textStatus, jqXHR)
                    }
                    if (webChangeCall) {
                        webChangeCall(true)
                    }
                },
                error: function (jqXHR) {
                    let status = jqXHR.status
                    console.log(jqXHR)
                    alert('Something went wrong')
                    if (errorCallback != null) {
                        errorCallback()
                    }
                }
            })
        }

        function renderChart(canvas, type, labels, data) {
            let ctx = document.getElementById(canvas).getContext('2d')
            if (type === "horizontalBar") {
                let myChart = new Chart(ctx, {
                    type: type,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Valency', // Name the series
                            data: data, // Specify the data values array
                            backgroundColor: '#f39c12',
                            borderColor: '#f39c12',
                            borderWidth: 1 // Specify bar border width
                        }]
                    },
                    options: {
                        responsive: true, // Instruct chart js to respond nicely.
                        maintainAspectRatio: false, // Add to prevent default behaviour of full-width/height
                        scales: {
                            yAxes: [
                                {
                                    ticks: {
                                        min: 0,
                                        max: 1
                                    }
                                },
                            ],
                        }
                    },

                })
            }
        }

        let params = getHashParams()

        let access_token = params.access_token,
            refresh_token = params.refresh_token,
            error = params.error

        if (error) {
            window.location.redirect("http://localhost:8888/login")
        } else {
            if (access_token) {
                renderData(null, "/me", null, false, null, null, processLogin)
                renderData(null, "/me/player/recently-played", null, false, getTracks)
            } else {
                // render initial screen
                processLogin(false)
            }
        }
    })()
</script>
</body>
</html>

